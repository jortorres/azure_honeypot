<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">.lst-kix_y3q0e6hhito0-2>li{counter-increment:lst-ctn-kix_y3q0e6hhito0-2}.lst-kix_y3q0e6hhito0-8>li{counter-increment:lst-ctn-kix_y3q0e6hhito0-8}ol.lst-kix_y3q0e6hhito0-0{list-style-type:none}ol.lst-kix_y3q0e6hhito0-4.start{counter-reset:lst-ctn-kix_y3q0e6hhito0-4 0}ol.lst-kix_y3q0e6hhito0-7{list-style-type:none}ol.lst-kix_y3q0e6hhito0-8{list-style-type:none}ol.lst-kix_y3q0e6hhito0-1.start{counter-reset:lst-ctn-kix_y3q0e6hhito0-1 0}ol.lst-kix_y3q0e6hhito0-5{list-style-type:none}ol.lst-kix_y3q0e6hhito0-6{list-style-type:none}ol.lst-kix_y3q0e6hhito0-3{list-style-type:none}ol.lst-kix_y3q0e6hhito0-4{list-style-type:none}ol.lst-kix_y3q0e6hhito0-1{list-style-type:none}ol.lst-kix_y3q0e6hhito0-2{list-style-type:none}.lst-kix_y3q0e6hhito0-3>li:before{content:"" counter(lst-ctn-kix_y3q0e6hhito0-3,decimal) ". "}.lst-kix_y3q0e6hhito0-1>li:before{content:"" counter(lst-ctn-kix_y3q0e6hhito0-1,lower-latin) ". "}.lst-kix_y3q0e6hhito0-5>li:before{content:"" counter(lst-ctn-kix_y3q0e6hhito0-5,lower-roman) ". "}.lst-kix_y3q0e6hhito0-0>li:before{content:"" counter(lst-ctn-kix_y3q0e6hhito0-0,decimal) ". "}.lst-kix_y3q0e6hhito0-4>li:before{content:"" counter(lst-ctn-kix_y3q0e6hhito0-4,lower-latin) ". "}ol.lst-kix_y3q0e6hhito0-5.start{counter-reset:lst-ctn-kix_y3q0e6hhito0-5 0}.lst-kix_y3q0e6hhito0-6>li{counter-increment:lst-ctn-kix_y3q0e6hhito0-6}ol.lst-kix_y3q0e6hhito0-8.start{counter-reset:lst-ctn-kix_y3q0e6hhito0-8 0}.lst-kix_y3q0e6hhito0-2>li:before{content:"" counter(lst-ctn-kix_y3q0e6hhito0-2,lower-roman) ". "}.lst-kix_y3q0e6hhito0-0>li{counter-increment:lst-ctn-kix_y3q0e6hhito0-0}.lst-kix_y3q0e6hhito0-3>li{counter-increment:lst-ctn-kix_y3q0e6hhito0-3}.lst-kix_y3q0e6hhito0-8>li:before{content:"" counter(lst-ctn-kix_y3q0e6hhito0-8,lower-roman) ". "}.lst-kix_y3q0e6hhito0-7>li:before{content:"" counter(lst-ctn-kix_y3q0e6hhito0-7,lower-latin) ". "}ol.lst-kix_y3q0e6hhito0-2.start{counter-reset:lst-ctn-kix_y3q0e6hhito0-2 0}.lst-kix_es8nbqwh7tat-0>li:before{content:"\0025cf   "}.lst-kix_y3q0e6hhito0-6>li:before{content:"" counter(lst-ctn-kix_y3q0e6hhito0-6,decimal) ". "}.lst-kix_es8nbqwh7tat-3>li:before{content:"\0025cf   "}.lst-kix_es8nbqwh7tat-2>li:before{content:"\0025a0   "}.lst-kix_es8nbqwh7tat-4>li:before{content:"\0025cb   "}.lst-kix_vdf1he7oj4wt-5>li:before{content:"-  "}.lst-kix_vdf1he7oj4wt-7>li:before{content:"-  "}.lst-kix_es8nbqwh7tat-1>li:before{content:"\0025cb   "}.lst-kix_es8nbqwh7tat-5>li:before{content:"\0025a0   "}.lst-kix_vdf1he7oj4wt-2>li:before{content:"-  "}.lst-kix_vdf1he7oj4wt-6>li:before{content:"-  "}.lst-kix_mejg90vbaukr-8>li:before{content:"-  "}.lst-kix_mejg90vbaukr-7>li:before{content:"-  "}.lst-kix_vdf1he7oj4wt-3>li:before{content:"-  "}.lst-kix_vdf1he7oj4wt-4>li:before{content:"-  "}ul.lst-kix_es8nbqwh7tat-8{list-style-type:none}ul.lst-kix_es8nbqwh7tat-7{list-style-type:none}ul.lst-kix_es8nbqwh7tat-6{list-style-type:none}ul.lst-kix_es8nbqwh7tat-5{list-style-type:none}ul.lst-kix_es8nbqwh7tat-4{list-style-type:none}.lst-kix_es8nbqwh7tat-7>li:before{content:"\0025cb   "}ul.lst-kix_es8nbqwh7tat-3{list-style-type:none}ul.lst-kix_es8nbqwh7tat-2{list-style-type:none}.lst-kix_es8nbqwh7tat-6>li:before{content:"\0025cf   "}.lst-kix_es8nbqwh7tat-8>li:before{content:"\0025a0   "}ul.lst-kix_es8nbqwh7tat-1{list-style-type:none}ol.lst-kix_y3q0e6hhito0-6.start{counter-reset:lst-ctn-kix_y3q0e6hhito0-6 0}ul.lst-kix_es8nbqwh7tat-0{list-style-type:none}.lst-kix_y3q0e6hhito0-5>li{counter-increment:lst-ctn-kix_y3q0e6hhito0-5}.lst-kix_vdf1he7oj4wt-8>li:before{content:"-  "}ul.lst-kix_mejg90vbaukr-6{list-style-type:none}ul.lst-kix_vdf1he7oj4wt-4{list-style-type:none}ul.lst-kix_mejg90vbaukr-7{list-style-type:none}ul.lst-kix_vdf1he7oj4wt-5{list-style-type:none}ul.lst-kix_mejg90vbaukr-8{list-style-type:none}ul.lst-kix_vdf1he7oj4wt-6{list-style-type:none}ul.lst-kix_vdf1he7oj4wt-7{list-style-type:none}ul.lst-kix_vdf1he7oj4wt-8{list-style-type:none}ol.lst-kix_y3q0e6hhito0-3.start{counter-reset:lst-ctn-kix_y3q0e6hhito0-3 0}.lst-kix_mejg90vbaukr-0>li:before{content:"-  "}ul.lst-kix_mejg90vbaukr-0{list-style-type:none}.lst-kix_mejg90vbaukr-1>li:before{content:"-  "}ul.lst-kix_mejg90vbaukr-1{list-style-type:none}ul.lst-kix_mejg90vbaukr-2{list-style-type:none}ul.lst-kix_vdf1he7oj4wt-0{list-style-type:none}ul.lst-kix_mejg90vbaukr-3{list-style-type:none}ul.lst-kix_vdf1he7oj4wt-1{list-style-type:none}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_y3q0e6hhito0-1>li{counter-increment:lst-ctn-kix_y3q0e6hhito0-1}ul.lst-kix_mejg90vbaukr-4{list-style-type:none}ul.lst-kix_vdf1he7oj4wt-2{list-style-type:none}ul.lst-kix_mejg90vbaukr-5{list-style-type:none}ul.lst-kix_vdf1he7oj4wt-3{list-style-type:none}.lst-kix_mejg90vbaukr-4>li:before{content:"-  "}.lst-kix_mejg90vbaukr-3>li:before{content:"-  "}.lst-kix_mejg90vbaukr-5>li:before{content:"-  "}ol.lst-kix_y3q0e6hhito0-0.start{counter-reset:lst-ctn-kix_y3q0e6hhito0-0 0}.lst-kix_y3q0e6hhito0-4>li{counter-increment:lst-ctn-kix_y3q0e6hhito0-4}.lst-kix_mejg90vbaukr-2>li:before{content:"-  "}.lst-kix_mejg90vbaukr-6>li:before{content:"-  "}.lst-kix_y3q0e6hhito0-7>li{counter-increment:lst-ctn-kix_y3q0e6hhito0-7}ol.lst-kix_y3q0e6hhito0-7.start{counter-reset:lst-ctn-kix_y3q0e6hhito0-7 0}.lst-kix_vdf1he7oj4wt-1>li:before{content:"-  "}.lst-kix_vdf1he7oj4wt-0>li:before{content:"-  "}ol{margin:0;padding:0}table td,table th{padding:0}.c9{-webkit-text-decoration-skip:none;color:#000000;font-weight:700;text-decoration:underline;vertical-align:baseline;text-decoration-skip-ink:none;font-size:11pt;font-family:"Arial";font-style:normal}.c0{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c7{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c11{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Courier New";font-style:normal}.c2{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c1{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c13{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;font-weight:700;text-decoration:underline}.c12{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c3{margin-left:36pt;padding-left:0pt}.c5{color:inherit;text-decoration:inherit}.c6{padding:0;margin:0}.c14{font-weight:400;font-family:"Courier New"}.c10{font-style:italic}.c4{margin-left:36pt}.c8{height:11pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c12 doc-content"><p class="c2"><span class="c9">Part 1. Setup Azure Subscription</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span>Create Free Azure Subscription: </span><span class="c1"><a class="c5" href="https://www.google.com/url?q=https://azure.microsoft.com/en-us/pricing/purchase-options/azure-account&amp;sa=D&amp;source=editors&amp;ust=1746764309858398&amp;usg=AOvVaw1BKeEcNhWQ58CVHB1_uimg">https://azure.microsoft.com/en-us/pricing/purchase-options/azure-account</a></span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">If Azure doesn&rsquo;t let you create a free account, you can either</span></p><ol class="c6 lst-kix_y3q0e6hhito0-0 start" start="1"><li class="c2 c3 li-bullet-0"><span class="c0">Create a paid subscription and be mindful of shutting down/deleting your resources when you are done, or</span></li><li class="c2 c3 li-bullet-0"><span>Sign up for the Cyber Range, where you pay a flat fee and get access to Azure, Tenable, Defender for Endpoint, Courses, Labs, Weekly lives, optional Cyber Internship: </span><span class="c1"><a class="c5" href="https://www.google.com/url?q=https://skool.com/cyber-range&amp;sa=D&amp;source=editors&amp;ust=1746764309859427&amp;usg=AOvVaw30rneIhkEG_i9Xm-x2M-pu">https://skool.com/cyber-range</a></span><span class="c0">&nbsp;</span></li></ol><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">After your subscription is created, you can login at:</span></p><p class="c2"><span class="c1"><a class="c5" href="https://www.google.com/url?q=https://portal.azure.com&amp;sa=D&amp;source=editors&amp;ust=1746764309859904&amp;usg=AOvVaw1VsnsIV_RAYdUdVSKXFCaa">https://portal.azure.com</a></span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c9">Part 2. Create the Honey Pot (Azure Virtual Machine)</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span>Go to: </span><span class="c1"><a class="c5" href="https://www.google.com/url?q=https://portal.azure.com&amp;sa=D&amp;source=editors&amp;ust=1746764309860582&amp;usg=AOvVaw0-e4jotZ5l0BEtCRRh27Tv">https://portal.azure.com</a></span><span>&nbsp;and search for virtual machines</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Create a new Windows 10 virtual machine (choose an appropriate size. If you are in the Cyber Range, the size will be limited. You notice the monthly cost of leaving the VM on 24/7. Be mindful of shutting this off when you are done, or just join the cyber range and we handle the back end expense). Remember the username and password</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Go to the Network Security Group for your virtual machine and create a rule that allows all traffic inbound</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Log into your virtual machine and turn off the windows firewall (start -&gt; wf.msc -&gt; properties -&gt; all off)</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c9">Part 3. Logging into the VM and inspecting logs</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Fail 3 logins as &ldquo;employee&rdquo; (or some other username)</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Login to your virtual machine</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Open up Event Viewer and inspect the security logs</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">See the 3 failed logins as &ldquo;employee&rdquo;, event ID 4625</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Next, we are going to create a central log repository called a LAW</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c9">Part 4. Log Forwarding and KQL</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Create Log Analytics Workspace</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Create a Sentinel Instance and connect it to Log Analytics</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">(observe architecture)</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Configure the &ldquo;Windows Security Events via AMA&rdquo; connector</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Create the DCR within sentinel, watch for extension creation</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Query for logs within the LAW</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">We can now query the Log analytics workspace as well as the SIEM, sentinel directly, which we will do soon</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2 c4"><span>Note: Querying logs in here is a really important skill that you MUST have if you want to work in security operations. Depending on where you work, you need to know SQL, KQL, or SPL, but these are all basically the same thing. If you know one, you can easily learn the others. Microsoft and Sentinel uses KQL, which you can learn in the Cyber Range </span><span class="c1"><a class="c5" href="https://www.google.com/url?q=https://skool.com/cyber-range&amp;sa=D&amp;source=editors&amp;ust=1746764309866439&amp;usg=AOvVaw3ZtA4uQF1v1P1zGfw7eLHT">https://skool.com/cyber-range</a></span><span>, or from here </span><span class="c1"><a class="c5" href="https://www.google.com/url?q=https://kc7cyber.com/&amp;sa=D&amp;source=editors&amp;ust=1746764309866650&amp;usg=AOvVaw1-4T-dOaFvrU2ZS4HjfGjH">https://kc7cyber.com/</a></span><span class="c0">&nbsp;(free)</span></p><p class="c2 c4 c8"><span class="c0"></span></p><p class="c2 c4"><span>Tip: The Cyber Range is basically a full production environment with </span><span class="c10">hundreds</span><span>&nbsp;of users and Virtual Machines in it, which are all producing a ton of logs. It&rsquo;s a really good place to practice just sifting through logs and seeing what you can see.</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Observe some of your VM logs:</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2 c4"><span class="c11">SecurityEvent</span></p><p class="c2 c4"><span class="c14">| where EventId == 4625</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">(observe architecture)</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c13">Part 5. Log Enrichment and Finding Location Data</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Observe the SecurityEvent logs in the Log Analytics Workspace; there is no location data, only IP address, which we can use to derive the location data.</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">We are going to import a spreadsheet (as a &ldquo;Sentinel Watchlist&rdquo;) which contains geographic information for each block of IP addresses.</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span>Download: </span><span class="c1"><a class="c5" href="https://www.google.com/url?q=https://drive.google.com/file/d/13EfjM_4BohrmaxqXZLB5VUBIz2sv9Siz/view?usp%3Dsharing&amp;sa=D&amp;source=editors&amp;ust=1746764309869564&amp;usg=AOvVaw1SVP0_vIjsQXuDZEfNwrfW">geoip-summarized.csv</a></span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Within Sentinel, create the watchlist:</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2 c4"><span class="c7">Name/Alias: geoip</span></p><p class="c2 c4"><span class="c7">Source type: Local File</span></p><p class="c2 c4"><span class="c7">Number of lines before row: 0</span></p><p class="c2 c4"><span class="c7">Search Key: network</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Allow the watchlist to fully import, there should be a total of roughly 54,000 rows.</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">In real life, this location data would come from a live source or it would be updated automatically on the back end by your service provider.</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">(observe architecture)</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Observe the logs now have geographic information, so you can see where the attacks are coming from</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2 c4"><span class="c11">let GeoIPDB_FULL = _GetWatchlist(&quot;geoip&quot;);</span></p><p class="c2 c4"><span class="c11">let WindowsEvents = SecurityEvent</span></p><p class="c2 c4"><span class="c11">&nbsp; &nbsp; | where IpAddress == &lt;attacker IP address&gt;</span></p><p class="c2 c4"><span class="c11">&nbsp; &nbsp; | where EventID == 4625</span></p><p class="c2 c4"><span class="c11">&nbsp; &nbsp; | order by TimeGenerated desc</span></p><p class="c2 c4"><span class="c11">&nbsp; &nbsp; | evaluate ipv4_lookup(GeoIPDB_FULL, IpAddress, network);</span></p><p class="c2 c4"><span class="c11">WindowsEvents</span></p><p class="c2 c4 c8"><span class="c11"></span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">(observe architecture)</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c9">Part 6. Attack Map Creation</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Within Sentine, create a new Workbook</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Delete the prepopulated elements and add a &ldquo;Query&rdquo; element</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Go to the advanced editor tab, and paste the JSON</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Workbook (Attack map):</span></p><p class="c2"><span class="c1"><a class="c5" href="https://www.google.com/url?q=https://drive.google.com/file/d/1ErlVEK5cQjpGyOcu4T02xYy7F31dWuir/view?usp%3Ddrive_link&amp;sa=D&amp;source=editors&amp;ust=1746764309874068&amp;usg=AOvVaw2I3kstOjicYVzZ_S55IQNq">map.json</a></span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Observe the query</span></p><p class="c2"><span class="c0">Observe the map settings</span></p><p class="c2"><span class="c0">Observe the map</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span class="c0">Finished!</span></p><p class="c2 c8"><span class="c0"></span></p><p class="c2"><span>If you liked this lab, join the Cyber Range: </span><span class="c1"><a class="c5" href="https://www.google.com/url?q=https://skool.com/cyber-range&amp;sa=D&amp;source=editors&amp;ust=1746764309874967&amp;usg=AOvVaw3HG_M53LXbFq0HJXVYNJSt">https://skool.com/cyber-range</a></span><span class="c0">&nbsp;</span></p><ul class="c6 lst-kix_es8nbqwh7tat-0 start"><li class="c2 c3 li-bullet-0"><span class="c0">Access to an actual work environment with licensed enterprise security tools</span></li><li class="c2 c3 li-bullet-0"><span class="c0">Weekly live calls with me</span></li><li class="c2 c3 li-bullet-0"><span class="c0">Internships</span></li><li class="c2 c3 li-bullet-0"><span class="c0">Community</span></li><li class="c2 c3 li-bullet-0"><span class="c0">Threat hunts with cash prizes</span></li></ul></body></html>